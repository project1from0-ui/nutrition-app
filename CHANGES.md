# 新機能実装完了レポート

実装日時: 2025年11月16日

## 実装した機能一覧

### 1. ユーザープロフィール・MODEに基づく個別のkcal/PFC目標値作成機能 ✅

**実装内容:**
- ユーザーの基本情報（年齢、性別、身長、体重、運動頻度）とMODE（減量/現状維持/バルクアップ）に基づいて、個別化されたカロリーとPFC（タンパク質・脂質・炭水化物）の1日の目標値を自動計算
- Harris-Benedict式で基礎代謝量（BMR）を計算
- 活動レベル係数を適用してTDEE（総消費カロリー）を算出
- MODEに応じたカロリー調整（減量: -500kcal、バルクアップ: +300kcal、維持: ±0kcal）
- PFCバランスの自動計算（タンパク質: 体重×1.6-2.0g、脂質: 総カロリーの25%、炭水化物: 残りカロリー）

**変更ファイル:**
- `app/page.js` の `calculateDailyIntake()` 関数を拡張

**表示場所:**
- メインページの「今日の栄養摂取」セクションに目標値として表示

---

### 2. MODEページに目標期間・目標体重設定オプションを追加 ✅

**実装内容:**
- MODEページの下部に目標設定セクションを追加
- 目標体重（kg）と目標期間（週）を入力可能に
- 設定した目標に基づいて1日の推奨カロリーを自動調整
- 1kgの体重変化 ≈ 7200kcalとして計算
- 極端な制限を防ぐ安全機能（BMRの80%〜TDEE+500の範囲内）
- 入力値はlocalStorageに自動保存

**変更ファイル:**
- `app/page.js` にstate変数 `targetWeight`, `targetPeriod` を追加
- MODEページに入力フォームを追加
- `calculateDailyIntake()` 関数に目標体重・期間ベースのカロリー計算ロジックを追加

**表示場所:**
- MODEページの3つのモードボタンの下に小さく表示

---

### 3. メインページに目標値カスタマイズ機能を追加 ✅

**実装内容:**
- 「今日の栄養摂取」セクションに「目標変更」ボタンを追加
- モーダル形式で目標カロリー、タンパク質、脂質、炭水化物の値を個別にカスタマイズ可能
- カスタマイズした値は自動計算された目標値より優先される
- 「リセット」ボタンでカスタマイズを解除し、自動計算に戻せる
- カスタマイズ状態は「✓ カスタム」ボタンで視覚的に確認可能
- 設定値はlocalStorageに保存

**変更ファイル:**
- `app/page.js` にstate変数 `customTargets`, `showTargetCustomizer` を追加
- 目標値カスタマイザーモーダルを実装
- `calculateDailyIntake()` 関数でカスタム目標値を優先使用

**表示場所:**
- メインページ「今日の栄養摂取」セクションの右上に「目標変更」ボタン
- クリックでモーダルが開く

---

### 4. 店外ボタン後のランキング表示に基準を明確化 ✅

**実装内容:**
- ランキングページに「ランキング基準」セクションを追加
- ユーザーのMODEに応じた基準を明示
  - 減量: 低カロリー・高タンパク質・低脂質のメニューを優先
  - バルクアップ: 高タンパク質・適度なカロリーのメニューを優先
  - 現状維持: 栄養バランスが良く、適正カロリーのメニューを優先

**変更ファイル:**
- `app/page.js` の結果ページ（`results`セクション）に説明ボックスを追加

**表示場所:**
- 結果ページのタイトル下、ユーザー要望入力欄の上

---

### 5. 店外ランキングページにGemini統合（ユーザー要望反映） ✅

**実装内容:**
- Gemini AIを活用したランキングカスタマイズ機能を実装
- ユーザーが「油っぽいのが嫌」「魚料理がいい」「野菜多めで」などの要望を自然言語で入力可能
- Gemini APIがユーザー要望とメニュー情報を分析し、最適な順番にメニューを並び替え
- リアルタイムでランキングが更新される
- 適用状態は「✓ 適用済み」ボタンで視覚的に確認可能
- Enterキーでも適用可能

**新規ファイル:**
- `app/api/gemini-menu-ranking/route.js` - Gemini APIを使用したメニューランキング調整エンドポイント

**変更ファイル:**
- `app/page.js` にstate変数 `userPreference`, `isApplyingPreference`, `preferenceApplied` を追加
- 結果ページにユーザー要望入力欄と適用ボタンを追加

**表示場所:**
- 結果ページのランキング基準説明の下

---

### 6. 店外ランキングページのフィルター機能を実装（Gemini活用） ✅

**実装内容:**
- 既存のカテゴリフィルター機能を維持
- Geminiによるユーザー要望入力が実質的な高度なフィルターとして機能
- カテゴリ（ALL / 各カテゴリ）によるメニュー絞り込みが可能
- Geminiによる要望適用とカテゴリフィルターを組み合わせて使用可能

**変更ファイル:**
- 既存のカテゴリフィルター機能を活用（変更なし）
- Gemini要望入力機能と連携

**表示場所:**
- 結果ページのユーザー要望入力欄の下

---

## 技術的な詳細

### 使用技術
- **フロントエンド:** React (Next.js 14.2.18)
- **AI統合:** Google Gemini API (gemini-2.0-flash-exp)
- **データ永続化:** localStorage
- **スタイリング:** インラインCSS、動的スタイル制御

### 新規追加されたstate変数
```javascript
// 目標設定関連
const [targetWeight, setTargetWeight] = useState('');
const [targetPeriod, setTargetPeriod] = useState('');
const [customTargets, setCustomTargets] = useState(null);
const [showTargetCustomizer, setShowTargetCustomizer] = useState(false);

// Geminiランキング調整関連
const [userPreference, setUserPreference] = useState('');
const [isApplyingPreference, setIsApplyingPreference] = useState(false);
const [preferenceApplied, setPreferenceApplied] = useState(false);
```

### 新規追加されたAPI
- **POST /api/gemini-menu-ranking** - ユーザー要望に基づいてメニューランキングを調整

### データフロー
1. ユーザーがプロフィール情報とMODEを設定
2. `calculateDailyIntake()` が個別化された目標値を計算
3. 目標体重・期間が設定されていれば、それに基づいてカロリーを調整
4. カスタム目標値が設定されていれば、それを優先使用
5. メインページに目標値と現在の摂取量を表示
6. 店外ボタンクリック時、MODEに基づいたランキング基準でメニューを並び替え
7. ユーザー要望が入力されたら、Gemini APIでランキングを再調整

---

## ユーザー体験の改善

### ビフォー
- 全ユーザー共通の固定された目標値
- ランキング基準が不明確
- 個人の好みを反映できない
- 目標設定の柔軟性が低い

### アフター
- 個人に最適化された目標値（年齢、性別、体重、活動レベル、MODE）
- 目標体重と期間を設定して自動カロリー調整
- 手動で目標値をカスタマイズ可能
- ランキング基準が明確に表示
- AIによる自然言語での要望入力（「魚料理がいい」など）
- リアルタイムでランキングをカスタマイズ

---

## localStorageに保存されるデータ

```javascript
{
  // 既存
  "birthYear": 1990,
  "birthMonth": 6,
  "birthDay": 15,
  "gender": "male",
  "height": 175,
  "weight": 70,
  "exerciseFrequency": "moderate",
  "exerciseTypes": ["筋トレ"],
  "goal": "diet",

  // 新規追加
  "targetWeight": 65,              // 目標体重（kg）
  "targetPeriod": 12,               // 目標期間（週）
  "customTargets": {                // カスタム目標値
    "calories": 2000,
    "protein": 120,
    "fat": 55,
    "carbs": 250
  }
}
```

---

## 動作確認項目

✅ MODEページで目標体重・期間を入力し、カロリーが自動調整される
✅ メインページで「目標変更」ボタンをクリックし、カスタム目標値を設定できる
✅ カスタム目標値がメインページの栄養サマリーに反映される
✅ カスタム目標値を「リセット」ボタンで解除できる
✅ 店外ボタン後の結果ページにランキング基準が表示される
✅ 結果ページでユーザー要望を入力し、「適用」ボタンでランキングが変更される
✅ 適用状態が「✓ 適用済み」ボタンで確認できる
✅ Enterキーでも要望を適用できる
✅ 設定値がページリロード後も保持される（localStorage）

---

## 注意事項

1. **Gemini API キーが必要:** `.env.local` に `GEMINI_API_KEY` が設定されている必要があります
2. **ブラウザの互換性:** localStorage を使用しているため、プライベートブラウジングモードでは一部機能が制限される可能性があります
3. **カロリー計算の安全機能:** 極端な減量/増量を防ぐため、目標カロリーはBMRの80%〜TDEE+500の範囲内に制限されます

---

## 今後の拡張可能性

- 週ごとの体重変化グラフ表示
- 過去の目標達成履歴の記録
- 栄養素の詳細分析（ビタミン、ミネラルなど）
- 複数の目標プランの保存・切り替え
- ソーシャル機能（目標共有、コミュニティ）

---

## まとめ

6つの機能すべてを実装しました。アプリは以下の点で大きく改善されました：

1. **パーソナライゼーション:** 各ユーザーに最適化された目標値
2. **柔軟性:** 目標体重・期間設定、手動カスタマイズの両方に対応
3. **透明性:** ランキング基準が明確に表示
4. **AI活用:** Geminiによる自然言語での要望入力
5. **ユーザビリティ:** 直感的なUI、リアルタイムフィードバック

すべての変更はlocalStorageに保存されるため、ユーザーの設定はブラウザを閉じても保持されます。
